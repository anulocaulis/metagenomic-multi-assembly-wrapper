Bootstrap: docker
From: ubuntu:20.04

# to build
# export SINGULARITY_BIND=
# singularity build --fakeroot longread_preliminary.sif longread_preliminary.def

%post
    # Update packages and install core dependencies
    apt-get update
    apt-get install -y --no-install-recommends \
        build-essential wget curl unzip git \
        python3 python3-pip python3-setuptools \
        libncurses-dev \
        zlib1g-dev libbz2-dev liblzma-dev libcurl4-openssl-dev libssl-dev \
        openjdk-11-jre-headless

    # Install samtools
    wget https://github.com/samtools/samtools/releases/download/1.19.2/samtools-1.19.2.tar.bz2
    tar -xf samtools-1.19.2.tar.bz2
    cd samtools-1.19.2
    ./configure
    make
    make install
    cd /
    rm -rf samtools-1.19.2 samtools-1.19.2.tar.bz2

    # Install FastQC
    wget https://www.bioinformatics.babraham.ac.uk/projects/fastqc/fastqc_v0.12.1.zip -O fastqc.zip
    unzip fastqc.zip -d /opt/
    chmod 755 /opt/FastQC/fastqc
    rm fastqc.zip

    # Install filtlong
    # filtlong requires minimap2. We'll install minimap2 first.
    git clone https://github.com/lh3/minimap2.git /opt/minimap2
    cd /opt/minimap2
    make
    # No 'make install' needed for minimap2, we'll add its path directly

    cd /
    git clone https://github.com/rrwick/Filtlong.git /opt/filtlong
    cd /opt/filtlong
    # Filtlong uses a Makefile, but often requires a specific Python setup or simply placing the script in PATH
    # For simplicity, we'll just ensure the script is executable and add its directory to PATH
    chmod +x filtlong.py
    cd /

    # Install Flye
    wget https://github.com/fenderglass/Flye/releases/download/2.9.2/flye-2.9.2-Linux.tar.gz
    tar -xzf flye-2.9.2-Linux.tar.gz -C /opt/
    rm flye-2.9.2-Linux.tar.gz
    mv /opt/flye-2.9.2-Linux /opt/flye # Rename for cleaner path

    # Clean up APT cache
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%environment
    export PATH="/usr/local/bin:/opt/FastQC:/opt/filtlong:/opt/minimap2:/opt/flye/bin:$PATH"

%runscript
    echo "This container includes samtools, FastQC, filtlong, and Flye."
    echo "To run a specific tool, specify it as an argument, e.g.:"
    echo "singularity exec genomics_tools.sif samtools --version"
    echo "singularity exec genomics_tools.sif fastqc --version"
    echo "singularity exec genomics_tools.sif filtlong --version"
    echo "singularity exec genomics_tools.sif flye --version"
    exec "$@"

%labels
    Maintainer lowry-nitrogen-team
    CreationDate 2025-07-22
    Version 1.0
    Description Singularity container with preliminary QC tools for long reads: samtools, FastQC, filtlong, Flye.

%help
    This Singularity container provides a ready-to-use environment for several
    common genomics analysis tools:
    - samtools (for BAM/SAM file manipulation)
    - FastQC (for quality control of sequencing data)
    - filtlong (for filtering long reads)
    - Flye (for de novo genome assembly)

    To use a tool, execute the container and specify the tool's command:
    singularity exec genomics_tools.sif samtools <subcommand>
    singularity exec genomics_tools.sif fastqc <options> <files>
    singularity exec genomics_tools.sif filtlong <options> <input_file>
    singularity exec genomics_tools.sif flye <options>

    For example:
    singularity exec genomics_tools.sif samtools --version
    singularity exec genomics_tools.sif fastqc --help
    singularity exec genomics_tools.sif filtlong --help
    singularity exec genomics_tools.sif flye --help
