Bootstrap: docker
From: ubuntu:22.04

# QC and Read Preparation Container
# Includes: BBTools (bbduk, reformat), samtools, chopper, bwa, fastqc
#
# To build this container:
# sudo singularity build qc_tools.sif qc_tools.def

%environment
    export LC_ALL=C
    export PATH=/opt/bbmap:/usr/local/bin:$PATH

%post
    # Update and install core system dependencies
    apt-get update -y
    apt-get install -y --no-install-recommends \
        build-essential \
        autoconf \
        automake \
        cmake \
        wget \
        git \
        curl \
        unzip \
        zlib1g-dev \
        libbz2-dev \
        liblzma-dev \
        libcurl4-openssl-dev \
        libssl-dev \
        libncurses-dev \
        python3 \
        python3-pip \
        default-jre \
        ca-certificates

    # Install samtools (1.19.2)
    cd /tmp
    wget https://github.com/samtools/samtools/releases/download/1.19.2/samtools-1.19.2.tar.bz2
    tar -xf samtools-1.19.2.tar.bz2
    cd samtools-1.19.2
    ./configure --prefix=/usr/local
    make -j$(nproc)
    make install
    cd /tmp
    rm -rf samtools-*

    # Install BWA (0.7.18)
    cd /tmp
    git clone https://github.com/lh3/bwa.git
    cd bwa
    git checkout v0.7.18
    make -j$(nproc)
    cp bwa /usr/local/bin/
    cd /tmp
    rm -rf bwa

    # Install BBTools (BBMap suite) - includes bbduk.sh, reformat.sh
    cd /opt
    wget https://sourceforge.net/projects/bbmap/files/BBMap_39.06.tar.gz
    tar -xzf BBMap_39.06.tar.gz
    rm BBMap_39.06.tar.gz
    # BBTools are now in /opt/bbmap/
    
    # Install Rust (needed for chopper)
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    export PATH="/root/.cargo/bin:$PATH"
    
    # Install chopper (v0.7.0)
    /root/.cargo/bin/cargo install chopper --version 0.7.0
    cp /root/.cargo/bin/chopper /usr/local/bin/

    # Install FastQC (optional, for QC reports)
    cd /tmp
    wget https://www.bioinformatics.babraham.ac.uk/projects/fastqc/fastqc_v0.12.1.zip
    unzip fastqc_v0.12.1.zip
    mv FastQC /opt/
    chmod +x /opt/FastQC/fastqc
    ln -s /opt/FastQC/fastqc /usr/local/bin/fastqc
    rm fastqc_v0.12.1.zip

    # Clean up
    apt-get clean
    rm -rf /var/lib/apt/lists/* /tmp/*

%environment
    # Add BBTools to PATH
    export PATH="/opt/bbmap:/usr/local/bin:/opt/FastQC:$PATH"
    export LC_ALL=C

%runscript
    echo "=========================================================="
    echo "QC and Read Preparation Tools Container"
    echo "=========================================================="
    echo "Available tools:"
    echo "  - samtools (BAM/SAM manipulation)"
    echo "  - bwa (read mapping)"
    echo "  - chopper (long-read quality filtering)"
    echo "  - bbduk.sh (Illumina adapter/quality trimming)"
    echo "  - reformat.sh (FASTQ/BAM conversion)"
    echo "  - fastqc (quality control reports)"
    echo "=========================================================="
    echo "Usage: singularity exec qc_tools.sif <tool> <args>"
    echo "=========================================================="
    exec "$@"

%labels
    Maintainer lowry-nitrogen-team
    CreationDate 2026-01-28
    Version 1.0
    Description QC container with BBTools, samtools, bwa, chopper, fastqc

%help
    This container provides quality control and read preparation tools:
    
    Tools included:
    - samtools: BAM/SAM file manipulation and format conversion
    - bwa: Burrows-Wheeler Aligner for read mapping
    - chopper: Quality and length filtering for long reads
    - bbduk.sh: Adapter trimming and quality filtering (BBTools)
    - reformat.sh: File format conversion (BBTools)
    - fastqc: Quality control reports
    
    Example usage:
    singularity exec qc_tools.sif samtools --version
    singularity exec qc_tools.sif chopper --help
    singularity exec qc_tools.sif bbduk.sh --help
    singularity exec qc_tools.sif reformat.sh --help
